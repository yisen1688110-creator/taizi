<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GQ Trade - ÂÆ¢ÊúçÊéßÂà∂Âè∞</title>
  <link rel="icon" href="/im-api/tiny.png" />
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden
    }

    body {
      font-family: ui-sans-serif, system-ui, -apple-system;
      margin: 0;
      background: #f5f7fb
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
    }

    .sidebar {
      width: 280px;
      background: #ffffff;
      border-right: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column
    }

    .sidebar-top {
      padding: 12px;
      display: flex;
      gap: 8px
    }

    .sidebar-search {
      flex: 1
    }

    .sidebar-btn {
      padding: 8px 12px;
      border: 0;
      border-radius: 6px;
      background: #2563eb;
      color: #fff;
      cursor: pointer
    }
    
    .sidebar-btn:hover {
      background: #1d4ed8
    }

    .conversation-list {
      flex: 1;
      overflow-y: auto
    }

    .conversation-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #e2e8f0;
      cursor: pointer;
      background: transparent
    }

    .conversation-item:hover {
      background: #f0f4f8
    }

    .read-pill {
      background: #2563eb;
      color: #fff;
      border-radius: 10px;
      padding: 0 6px;
      height: 20px;
      line-height: 20px;
      font-size: 12px
    }

    .read-pill.unread {
      background: #f59e0b
    }

    .ci-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 0
    }

    .ci-name {
      font-weight: 600;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .ci-meta {
      font-size: 12px;
      color: #64748b;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%
    }

    .dot.online {
      background: #16a34a
    }

    .dot.offline {
      background: #cbd5e1
    }

    .unread-badge {
      background: #2563eb;
      color: #fff;
      border-radius: 10px;
      padding: 0 6px;
      height: 20px;
      line-height: 20px;
      font-size: 12px;
      align-self: center;
      display: none
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column
    }

    .rightbar {
      width: 280px;
      background: #ffffff;
      border-left: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column
    }

    .rightbar-title {
      padding: 12px;
      font-weight: 600;
      color: #1e293b
    }

    .note-editor {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-bottom: 1px solid #e5e8ef
    }

    .note-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 5px
    }

    .note-list #noteCards {
      display: flex;
      flex-direction: column;
      gap: 5px
    }

    .note-card {
      position: relative
    }

    .card-menu-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: #3b82f6;
      color: #fff
    }

    .card-menu {
      position: absolute;
      top: 40px;
      right: 8px;
      background: #ffffff;
      color: #1e293b;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      min-width: 160px;
      z-index: 10000;
      user-select: none
    }

    .card-menu .popup-item {
      color: #1e293b;
      background: #ffffff;
      border-radius: 8px;
      -webkit-tap-highlight-color: transparent;
      outline: none
    }

    .card-menu .popup-item {
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 500
    }

    .card-menu .popup-item:hover {
      background: #f0f4f8
    }

    .note-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 10px
    }

    .note-card-head {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 6px
    }

    .note-card-body {
      color: #1e293b;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-all;
    }

    #noteInfo .note-card-body {
      white-space: normal;
    }

    .header {
      padding: 12px;
      background: #ffffff;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    .user {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      background: #eee
    }

    .name {
      font-weight: 600;
      color: #1e293b
    }

    .phone {
      color: #64748b;
      font-size: 12px
    }

    .meta {
      display: flex;
      gap: 8px
    }

    .badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px
    }

    .badge.online {
      background: #dcfce7;
      color: #16a34a
    }

    .badge.offline {
      background: #f1f5f9;
      color: #64748b
    }

    .badge.read {
      background: #dcfce7;
      color: #16a34a
    }

    .badge.unread {
      background: #fef3c7;
      color: #d97706
    }

    .note {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: #fff;
      border-bottom: 1px solid #eee
    }

    .setup {
      padding: 12px;
      display: flex;
      gap: 8px;
      background: #fff
    }

    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-anchor: none
    }

    .container.customer .messages {
      background: transparent;
    }

    .composer {
      padding: 12px;
      background: #ffffff;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 8px
    }

    input,
    textarea {
      padding: 8px 10px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      flex: 1;
      resize: none;
      background: #ffffff;
      color: #1e293b
    }
    
    input::placeholder,
    textarea::placeholder {
      color: #94a3b8
    }
    
    input:focus,
    textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1)
    }

    textarea {
      overflow-y: hidden
    }

    button {
      padding: 8px 12px;
      border: 0;
      border-radius: 6px;
      background: #2563eb;
      color: #fff;
      cursor: pointer
    }
    
    button:hover {
      background: #1d4ed8
    }

    .msg {
      max-width: 66%;
      padding: 8px 10px;
      border-radius: 12px
    }

    .msg.me {
      margin-left: auto;
      background: #2563eb;
      color: #fff
    }

    .msg.other {
      margin-right: auto;
      background: #ffffff;
      color: #1e293b;
      border: 1px solid #e2e8f0
    }

    .msg.flash {
      box-shadow: 0 0 0 2px #3b82f6 inset
    }

    .reply {
      background: rgba(37, 99, 235, 0.08);
      color: #1e293b;
      border-left: 3px solid #2563eb;
      border-radius: 8px;
      padding: 6px 8px;
      margin-bottom: 6px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px
    }

    .reply {
      cursor: pointer
    }

    .hidden {
      display: none !important
    }

    /* ÂÆ¢Êà∑Á´ØÊöóËâ≤‰∏ªÈ¢ò */
    .theme-dark {
      background: #0e1726
    }

    .theme-dark {
      color: #e6edf7
    }

    .theme-dark .header {
      background: #0f1c2d;
      border-bottom-color: #16263d
    }

    .theme-dark .composer {
      background: #0f1c2d;
      border-top-color: #16263d
    }

    .theme-dark .messages {
      background: #0e1726
    }

    .theme-dark input {
      background: #101d30;
      border-color: #1b2c48;
      color: #e6edf7
    }

    .theme-dark input::placeholder {
      color: #b9c6dc
    }

    .theme-dark button {
      background: #3b82f6;
      color: #fff
    }

    .theme-dark button:hover {
      background: #2563eb
    }

    .theme-dark .icon-btn {
      background: #3b82f6
    }

    .theme-dark .icon-btn:hover {
      background: #2563eb
    }

    .theme-dark .msg.me {
      background: #1ea7ff
    }

    .theme-dark .msg.other {
      background: #24364f;
      color: #e6edf7
    }

    .theme-dark .msg.flash {
      box-shadow: 0 0 0 2px #3b82f6 inset
    }

    .theme-dark .reply {
      background: #16263d;
      color: #93a4bf;
      border-left-color: #3b82f6
    }

    .theme-dark .reply {
      cursor: pointer
    }

    .reply-thumb {
      width: 48px;
      height: 36px;
      object-fit: cover;
      border-radius: 6px
    }

    .theme-dark .reply-thumb {
      border: 1px solid #1b2c48
    }

    .theme-dark .name {
      color: #e6edf7
    }

    .theme-dark .phone {
      color: #93a4bf
    }

    .header-mobile {
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 5;
      background: #0f1c2d;
      border-bottom: 1px solid #16263d;
      padding: 12px
    }

    .service-label {
      width: 28px;
      height: 28px;
      border-radius: 14px;
      background: #3b82f6;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600
    }

    .back-btn {
      position: fixed;
      top: 10px;
      left: 10px;
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: #8dd7ff;
      cursor: pointer;
      z-index: 6
    }

    .back-btn:hover {
      color: #c8e7ff
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: #2563eb;
      color: #fff
    }
    
    .icon-btn:hover {
      background: #1d4ed8
    }

    .popup-menu {
      position: absolute;
      bottom: 60px;
      left: 12px;
      background: #fff;
      border: 1px solid #e5e8ef;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
      padding: 8px;
      z-index: 10000
    }

    .popup-menu.card-menu {
      background: #ffffff;
      border-color: #e2e8f0;
      color: #1e293b
    }

    .popup-item {
      padding: 8px 10px;
      cursor: pointer;
      display: block;
      color: #1e293b
    }
    
    .popup-item:hover {
      background: #f0f4f8
    }

    .emoji-item {
      display: inline-block;
      font-size: 20px;
      padding: 6px;
      cursor: pointer
    }

    .msg-image {
      max-width: 60%;
      border-radius: 12px
    }

    .composer {
      position: relative
    }

    .container.customer .composer {
      position: sticky;
      bottom: 0;
      z-index: 6
    }

    .reply-preview {
      position: absolute;
      left: 12px;
      right: 120px;
      bottom: 68px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08)
    }

    .reply-preview-text {
      color: #1e293b;
      font-size: 12px;
      opacity: .9;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap
    }

    .reply-preview-cancel {
      background: #2563eb;
      color: #fff;
      border: 0;
      border-radius: 6px;
      padding: 6px 10px
    }

    .container.customer {
      max-width: none;
      width: 100%;
      margin: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding-top: 56px;
      padding-bottom: 0;
      box-sizing: border-box;
      overflow: hidden
    }

    #sendBtn {
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 18px;
      background: #2563eb;
      display: flex;
      align-items: center;
      justify-content: center
    }

    #sendBtn:hover {
      filter: brightness(1.05)
    }

    #sendBtn svg {
      width: 20px;
      height: 20px
    }

    /* ÂõæÁâáÊîæÂ§ßÊü•Áúã */
    .lightbox {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50
    }

    .lightbox img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 12px
    }

    /* ÊöóËâ≤‰∏ªÈ¢òÊâ©Â±ïÂà∞ËæπÊ†è‰∏éÂàóË°® */
    .theme-dark .sidebar {
      background: #111827;
      border-right-color: #334155
    }

    .theme-dark .rightbar {
      background: #111827;
      border-left-color: #334155
    }

    .theme-dark .conversation-item {
      border-bottom-color: #334155
    }

    .theme-dark .conversation-item:hover {
      background: #16263d
    }

    .theme-dark .ci-name {
      color: #e6edf7
    }

    .theme-dark .ci-meta {
      color: #93a4bf
    }

    .theme-dark .unread-badge {
      background: #1ea7ff;
      color: #fff
    }

    /* ËèúÂçïËÉåÊôØÈÅÆÁΩ© */
    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .3);
      z-index: 9998
    }

    .preview-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10001
    }

    .preview-box {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      padding: 12px;
      max-width: 90vw
    }

    .preview-image {
      max-width: 80vw;
      max-height: 60vh;
      border-radius: 8px;
      display: block
    }

    .preview-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px
    }

    .preview-actions button {
      background: #f8fafc;
      color: #1e293b;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px 12px
    }

    .preview-actions button:hover {
      background: #f0f4f8
    }

    .msg-menu {
      position: fixed;
      background: #ffffff;
      color: #1e293b;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      min-width: 140px;
      z-index: 10002;
      padding: 6px 0
    }

    .msg-menu-item {
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer
    }

    .msg-menu-item.danger {
      color: #dc2626;
    }

    .msg-menu-item:hover {
      background: #f0f4f8;
    }

    /* Conversation Context Menu */
    .ctx-menu {
      position: fixed;
      background: white;
      border: 1px solid #ddd;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 20001;
      border-radius: 4px;
      padding: 4px 0;
      min-width: 120px;
    }

    .ctx-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      color: #333;
    }

    .ctx-menu-item:hover {
      background: #f5f5f5;
    }

    .ctx-menu-item.danger {
      color: #ff4d4f;
    }

    .pin-icon {
      font-size: 12px;
      margin-right: 4px;
      color: #1890ff;
    }
  </style>
</head>

<body class="theme-light">
  <div class="container">
    <div class="sidebar">
      <div class="sidebar-top">
        <input id="searchPhone" class="sidebar-search" placeholder="ÊêúÁ¥¢ÊâãÊú∫Âè∑ÊàñÂßìÂêç" />
        <button id="searchBtn" class="sidebar-btn search-btn">ÊêúÁ¥¢</button>
        <button id="testAudioBtn" class="sidebar-btn" style="background:none;color:#666;font-size:12px;padding:4px"
          title="ÊµãËØïÂ£∞Èü≥">üîä</button>
      </div>
      <div id="conversationList" class="conversation-list"></div>
    </div>
    <div class="main">
      <div class="header">
        <div class="user">
          <img id="avatar" class="avatar" />
          <div>
            <div id="name" class="name"></div>
            <div id="phone" class="phone"></div>
          </div>
        </div>
        <div class="meta">
          <span id="onlineBadge" class="badge"></span>
          <span id="readBadge" class="badge"></span>
        </div>
      </div>
      <div id="messages" class="messages"></div>
      <div class="composer">
        <button id="plusBtn" class="icon-btn">+</button>
        <textarea id="messageInput" placeholder="ËæìÂÖ•ÂõûÂ§ç" rows="1"></textarea>
        <button id="emojiBtn" class="icon-btn">üôÇ</button>
        <button id="sendBtn">ÂèëÈÄÅ</button>
        <div id="plusMenu" class="popup-menu hidden">
          <label class="popup-item">
            <input id="photoInput" type="file" accept="image/*" class="hidden" />
            ‰∏ä‰º†ÁÖßÁâá
          </label>
        </div>
        <div id="emojiMenu" class="popup-menu hidden">
          <div class="emoji-item">üòÄ</div>
          <div class="emoji-item">üëç</div>
          <div class="emoji-item">‚ù§Ô∏è</div>
          <div class="emoji-item">üéâ</div>
          <div class="emoji-item">ü§î</div>
        </div>
      </div>
    </div>
    <div id="rightbar" class="rightbar hidden">
      <div class="rightbar-title">Â§áÊ≥®</div>
      <div class="note-editor">
        <textarea id="noteInput" placeholder="ËæìÂÖ•Â§áÊ≥®ÂÜÖÂÆπ" rows="3"></textarea>
        <button id="saveNoteBtn" type="button">‰øùÂ≠òÂ§áÊ≥®</button>
      </div>
      <div class="note-list">
        <div class="note-card" id="noteInfo">
          <div class="note-card-head">ÂÆ¢Êà∑‰ø°ÊÅØ</div>
          <div class="note-card-body">
            <div>Âú®Á∫øÔºö<span id="rbOnline">-</span></div>
            <div>Â∑≤ËØªÔºö<span id="rbRead">-</span></div>
            <div>ÊâãÊú∫Âè∑Ôºö<span id="rbPhone">-</span></div>
            <div>ÊòµÁß∞Ôºö<span id="rbName">-</span></div>
            <div>ÂõΩÂÆ∂Ôºö<span id="rbCountry">-</span></div>
          </div>
        </div>
        <div id="noteCards"></div>
      </div>
    </div>
  </div>
  <script src="/im-api/socket.io/socket.io.js"></script>
  <script>
    const qs = new URLSearchParams(location.search)
    const qsToken = qs.get('token') || ''
    const lsToken = (typeof localStorage !== 'undefined' ? (localStorage.getItem('im:token') || '') : '')
    const token = qsToken || lsToken || 'imdevtoken'
    let apiBase = qs.get('api') || '/im-api'
    let wsBase = qs.get('ws') || ''
    const wsPath = qs.get('wspath') || ''
    const makeSocket = () => (wsBase ? io(wsBase, { auth: { token }, query: { token }, path: (wsPath || '/im-api/socket.io/') }) : io({ auth: { token }, query: { token }, path: (wsPath || '/im-api/socket.io/') }))
    let socket = makeSocket()
    const originalFetch = window.fetch.bind(window)
    window.fetch = (input, init = {}) => {
      try {
        let url = typeof input === 'string' ? input : (input && input.url ? input.url : '')
        if (url && url.startsWith('/api')) {
          const headers = { ...(init.headers || {}), ...(token ? { 'x-im-token': token } : {}) }
          if (token) {
            const hasQuery = url.includes('?')
            const hasTokenParam = /[?&](token|x-im-token)=/.test(url)
            if (!hasTokenParam) url = url + (hasQuery ? '&' : '?') + 'token=' + encodeURIComponent(token)
          }
          if (apiBase) {
            const base = apiBase.endsWith('/') ? apiBase.slice(0, -1) : apiBase
            url = base + url
          }
          const req = (typeof input === 'string') ? url : new Request(url, input)
          return originalFetch(req, { ...init, headers, credentials: 'include' })
        }
      } catch { }
      return originalFetch(input, init)
    }
    function showTokenBar() {
      const exist = document.getElementById('tokenBar')
      if (exist) { exist.style.display = 'flex'; return }
      const bar = document.createElement('div')
      bar.id = 'tokenBar'
      bar.style.position = 'fixed'
      bar.style.top = '8px'
      bar.style.right = '8px'
      bar.style.zIndex = '2000'
      bar.style.display = 'flex'
      bar.style.gap = '8px'
      const input = document.createElement('input')
      input.placeholder = 'ËæìÂÖ•IM‰ª§Áâå'
      input.style.width = '220px'
      input.style.padding = '6px 8px'
      input.style.borderRadius = '6px'
      const btn = document.createElement('button')
      btn.textContent = 'ËÆæÁΩÆ‰ª§Áâå'
      btn.onclick = () => { const v = input.value.trim(); if (!v) return; try { localStorage.setItem('im:token', v) } catch { }; location.reload() }
      bar.appendChild(input)
      bar.appendChild(btn)
      document.body.appendChild(bar)
    }
    if (!token && qs.get('tokenbar') === '1') { showTokenBar() }
    socket.on('connect_error', () => {
      try {
        apiBase = apiBase || 'http://127.0.0.1:3000'
        wsBase = wsBase || 'http://127.0.0.1:3000'
        try { socket.disconnect() } catch { }
        socket = makeSocket()
      } catch { }
    })
    socket.on('connect', () => {
      socket.emit('join', { phone: '', role: 'agent' })
      if (currentPhone) socket.emit('join', { phone: currentPhone, role: 'agent' })
    })
    const messagesEl = document.getElementById('messages')
    const sendBtn = document.getElementById('sendBtn')
    const messageInput = document.getElementById('messageInput')
    const composerEl = document.querySelector('.composer')
    const searchPhone = document.getElementById('searchPhone')
    const searchBtn = document.getElementById('searchBtn')
    const phoneEl = document.getElementById('phone')
    const nameEl = document.getElementById('name')
    const avatarEl = document.getElementById('avatar')
    const listEl = document.getElementById('conversationList')
    const onlineBadge = document.getElementById('onlineBadge')
    const readBadge = document.getElementById('readBadge')
    const noteInput = document.getElementById('noteInput')
    const saveNoteBtn = document.getElementById('saveNoteBtn')
    const rightbar = document.getElementById('rightbar')
    const rbOnline = document.getElementById('rbOnline')
    const rbRead = document.getElementById('rbRead')
    const rbPhone = document.getElementById('rbPhone')
    const rbName = document.getElementById('rbName')
    const rbCountry = document.getElementById('rbCountry')
    const noteCards = document.getElementById('noteCards')
    const emojiBtn = document.getElementById('emojiBtn')
    const emojiMenu = document.getElementById('emojiMenu')
    const plusBtn = document.getElementById('plusBtn')
    const plusMenu = document.getElementById('plusMenu')
    const photoInput = document.getElementById('photoInput')
    let currentPhone = null
    let conversations = []
    let msgs = []
    let replyToId = null
    let lastAgentTs = 0
    const menuOverlay = document.getElementById('menuOverlay') || (() => { const o = document.createElement('div'); o.id = 'menuOverlay'; o.className = 'menu-overlay hidden'; document.body.appendChild(o); return o })()
    const previewOverlay = document.getElementById('previewOverlay') || (() => { const o = document.createElement('div'); o.id = 'previewOverlay'; o.className = 'preview-overlay hidden'; const b = document.createElement('div'); b.className = 'preview-box'; const i = document.createElement('img'); i.className = 'preview-image'; const a = document.createElement('div'); a.className = 'preview-actions'; const c = document.createElement('button'); c.textContent = 'ÂèñÊ∂à'; const s = document.createElement('button'); s.textContent = 'ÂèëÈÄÅÂõæÁâá'; a.appendChild(c); a.appendChild(s); b.appendChild(i); b.appendChild(a); o.appendChild(b); document.body.appendChild(o); o._img = i; o._send = s; o._cancel = c; return o })()
    let autoScroll = false
    const mo = new MutationObserver(() => { if (autoScroll) messagesEl.scrollTop = messagesEl.scrollHeight })
    mo.observe(messagesEl, { childList: true })
    function forceScrollBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight
      requestAnimationFrame(() => { messagesEl.scrollTop = messagesEl.scrollHeight })
      setTimeout(() => { messagesEl.scrollTop = messagesEl.scrollHeight }, 50)
      setTimeout(() => { messagesEl.scrollTop = messagesEl.scrollHeight }, 150)
      setTimeout(() => { messagesEl.scrollTop = messagesEl.scrollHeight }, 300)
    }
    messagesEl.addEventListener('scroll', () => {
      const nearBottom = (messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight) < 20
      autoScroll = nearBottom
    })
    function getQuoteText(id) {
      if (!id && id !== 0) return null
      const sid = String(id)
      const q = msgs.find(x => String(x.id) === sid)
      if (q) return q.type === 'image' ? 'ÂõæÁâá' : (q.content || '')
      const el = messagesEl.querySelector('[data-id="' + sid + '"]')
      if (el) return el.querySelector('.msg-image') ? 'ÂõæÁâá' : (el.textContent || '')
      return null
    }
    composerEl.classList.add('hidden')
    const replyPreview = document.createElement('div')
    replyPreview.className = 'reply-preview hidden'
    const replyText = document.createElement('div')
    replyText.className = 'reply-preview-text'
    const replyCancel = document.createElement('button')
    replyCancel.className = 'reply-preview-cancel'
    replyCancel.textContent = 'ÂèñÊ∂àÂºïÁî®'
    replyPreview.appendChild(replyText)
    replyPreview.appendChild(replyCancel)
    composerEl.insertBefore(replyPreview, messageInput)
    replyCancel.onclick = () => { replyToId = null; replyPreview.classList.add('hidden'); replyText.textContent = '' }
    function setReply(m) {
      replyToId = m.id || null
      replyText.textContent = m.type === 'image' ? 'ÂõæÁâá' : (m.content || '')
      replyPreview.classList.remove('hidden')
    }

    function renderMessage(m) {
      const div = document.createElement('div')
      div.className = m.sender === 'agent' ? 'msg me' : 'msg other'
      div.dataset.id = m.id || ''
      if (m.reply_to != null) {
        const rp = document.createElement('div')
        rp.className = 'reply'
        const qt = getQuoteText(m.reply_to)
        if (qt) {
          if (qt === 'ÂõæÁâá') {
            const imgEl = messagesEl.querySelector('[data-id="' + m.reply_to + '"] .msg-image')
            if (imgEl) {
              const t = document.createElement('img')
              t.className = 'reply-thumb'
              t.src = imgEl.src
              rp.appendChild(t)
              const s = document.createElement('span')
              s.textContent = 'ÂõæÁâá'
              rp.appendChild(s)
            } else {
              rp.textContent = 'ÂõæÁâá'
            }
          } else {
            rp.textContent = qt
          }
        } else {
          rp.textContent = 'ÂºïÁî®Ê∂àÊÅØ'
          fetch('/api/message/' + encodeURIComponent(m.reply_to)).then(r => r.ok ? r.json() : null).then(row => {
            if (!row) return
            if (row.type === 'image') {
              rp.textContent = ''
              const t = document.createElement('img')
              t.className = 'reply-thumb'
              t.src = row.content
              rp.appendChild(t)
              const s = document.createElement('span')
              s.textContent = 'ÂõæÁâá'
              rp.appendChild(s)
            } else {
              rp.textContent = row.content || ''
            }
          })
        }
        div.appendChild(rp)
        rp.onclick = () => {
          const el = messagesEl.querySelector('[data-id="' + m.reply_to + '"]')
          if (!el) return
          const top = Math.max(0, el.offsetTop - (messagesEl.clientHeight - el.offsetHeight) / 2)
          messagesEl.scrollTo({ top, behavior: 'smooth' })
          el.classList.add('flash')
          setTimeout(() => { el.classList.remove('flash') }, 1200)
        }
      }
      if (m.type === 'recall') {
        div.textContent = 'Áî®Êà∑Â∑≤Êí§ÂõûÊ∂àÊÅØÔºö' + (m.content || '')
      } else if (m.type === 'image') {
        const img = document.createElement('img')
        img.src = m.content
        img.className = 'msg-image'
        img.onload = () => { if (autoScroll) forceScrollBottom() }
        div.appendChild(img)
      } else {
        const txt = document.createElement('div')
        txt.textContent = m.content
        div.appendChild(txt)
        if (m.sender === 'customer' && (!m.type || m.type === 'text')) {
          // Translation removed
        }
      }
      messagesEl.appendChild(div)
      if (autoScroll || m.sender === 'agent') {
        forceScrollBottom()
      }
      if (m.sender === 'agent') lastAgentTs = m.ts || lastAgentTs
      msgs.push(m)
      div.oncontextmenu = (e) => { e.preventDefault(); openMsgMenu(e, m) }
      let t
      div.addEventListener('touchstart', () => { t = setTimeout(() => openMsgMenu({ clientX: window.innerWidth / 2, clientY: window.innerHeight / 2 }, m), 500) })
      const cancel = () => { if (t) clearTimeout(t) }
      div.addEventListener('touchend', cancel)
      div.addEventListener('touchmove', cancel)
    }

    let activeMsgMenu = null
    function openMsgMenu(e, m) {
      if (activeMsgMenu) { activeMsgMenu.remove(); activeMsgMenu = null }
      const menu = document.createElement('div')
      menu.className = 'msg-menu'
      const mk = (text, cls, fn) => { const it = document.createElement('div'); it.className = 'msg-menu-item' + (cls ? ' ' + cls : ''); it.textContent = text; it.onclick = () => { fn(); closeMenu() }; return it }
      const closeMenu = () => { if (activeMsgMenu) { activeMsgMenu.remove(); activeMsgMenu = null; menuOverlay.classList.add('hidden') } }
      menu.appendChild(mk('ÂõûÂ§ç', '', () => setReply(m)))
      menu.appendChild(mk('Â§çÂà∂', '', () => { const v = m.type === 'image' ? m.content : (m.content || ''); if (navigator.clipboard) navigator.clipboard.writeText(v) }))
      if (m.sender === 'agent') menu.appendChild(mk('Êí§Âõû', 'danger', () => { socket.emit('recall', { phone: currentPhone, id: m.id, by: 'agent' }) }))
      menu.style.top = Math.min(e.clientY, window.innerHeight - 160) + 'px'
      menu.style.left = Math.min(e.clientX, window.innerWidth - 160) + 'px'
      document.body.appendChild(menu)
      activeMsgMenu = menu
      menuOverlay.classList.remove('hidden')
      menuOverlay.onclick = closeMenu
    }

    function setPresence(online) {
      onlineBadge.textContent = online ? 'Âú®Á∫ø' : 'Á¶ªÁ∫ø'
      onlineBadge.className = online ? 'badge online' : 'badge offline'
      rbOnline.textContent = online ? 'Âú®Á∫ø' : 'Á¶ªÁ∫ø'
    }

    function setReadStatus(isRead) {
      readBadge.textContent = isRead ? 'Â∑≤ËØª' : 'Êú™ËØª'
      readBadge.className = isRead ? 'badge read' : 'badge unread'
      rbRead.textContent = isRead ? 'Â∑≤ËØª' : 'Êú™ËØª'
    }

    function formatTime(ts) {
      if (!ts) return ''
      const d = new Date(ts)
      const now = new Date()
      const isToday = d.toDateString() === now.toDateString()
      return isToday ? d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : d.toLocaleDateString([], { month: 'numeric', day: 'numeric' })
    }

    function sortConversations() {
      if (!Array.isArray(conversations)) return
      conversations.sort((a, b) => {
        const pa = a.pinned ? 1 : 0
        const pb = b.pinned ? 1 : 0
        if (pa !== pb) return pb - pa
        return (b.last_ts || 0) - (a.last_ts || 0)
      })
    }

    function renderList(data) {
      listEl.innerHTML = ''
      const arr = Array.isArray(data) ? data : []
      sortConversations()
      let totalUnread = 0
      arr.forEach(item => {
        const row = document.createElement('div')
        row.className = 'conversation-item'
        const left = document.createElement('div')
        left.className = 'ci-left'
        const header = document.createElement('div')
        header.style.display = 'flex'
        header.style.justifyContent = 'space-between'
        header.style.width = '100%'
        const nameRow = document.createElement('div')
        nameRow.className = 'ci-name'
        if (item.pinned) {
          const pi = document.createElement('span')
          pi.className = 'pin-icon'
          pi.textContent = 'üìå'
          nameRow.appendChild(pi)
        }
        const dot = document.createElement('span')
        dot.className = item.online ? 'dot online' : 'dot offline'
        // Insert dot before name text
        const nameText = document.createTextNode(item.name || item.phone)
        const nameWrapper = document.createElement('span')
        nameWrapper.style.display = 'flex'
        nameWrapper.style.alignItems = 'center'
        nameWrapper.style.gap = '6px'
        nameWrapper.style.flex = '1'
        nameWrapper.style.minWidth = '0'
        nameWrapper.appendChild(dot)
        if (item.pinned) {
          const pi = document.createElement('span')
          pi.className = 'pin-icon'
          pi.textContent = 'üìå'
          nameWrapper.appendChild(pi)
        }
        const txt = document.createElement('span')
        txt.textContent = item.name || item.phone
        txt.style.overflow = 'hidden'
        txt.style.textOverflow = 'ellipsis'
        txt.style.whiteSpace = 'nowrap'
        nameWrapper.appendChild(txt)

        const timeSpan = document.createElement('span')
        timeSpan.style.fontSize = '12px'
        timeSpan.style.color = '#999'
        timeSpan.style.marginLeft = '4px'
        timeSpan.style.flexShrink = '0'
        timeSpan.textContent = formatTime(item.last_ts)

        header.appendChild(nameWrapper)
        header.appendChild(timeSpan)

        const meta = document.createElement('div')
        meta.className = 'ci-meta'
        meta.textContent = item.last_content || ''

        left.appendChild(header)
        left.appendChild(meta)

        const right = document.createElement('div')
        right.className = 'ci-right'
        // Only show unread badge on right, time is now in header
        const unreadCount = Number(item.unread_count || 0)
        totalUnread += unreadCount
        if (unreadCount > 0) {
          const read = document.createElement('span')
          read.className = 'read-pill unread'
          read.textContent = unreadCount > 99 ? '99+' : String(unreadCount)
          right.appendChild(read)
        }

        row.appendChild(left)
        row.appendChild(right)
        row.onclick = () => loadConversation(item.phone)
        row.oncontextmenu = (e) => {
          e.preventDefault()
          showContextMenu(e, item)
        }
        listEl.appendChild(row)
      })
      try { localStorage.setItem('im:conv', JSON.stringify(conversations)) } catch { }
      updateBadge(totalUnread)
    }

    function renderNoteCards(items) {
      noteCards.innerHTML = ''
      items.forEach(n => {
        const card = document.createElement('div')
        card.className = 'note-card'
        card.dataset.id = n.id

        const head = document.createElement('div')
        head.className = 'note-card-head'
        head.textContent = new Date(n.ts).toLocaleString()

        const body = document.createElement('div')
        body.className = 'note-card-body'
        body.textContent = n.content

        // Action Buttons Container
        const actions = document.createElement('div')
        actions.style.position = 'absolute'
        actions.style.top = '8px'
        actions.style.right = '8px'
        actions.style.display = 'flex'
        actions.style.gap = '6px'

        const editBtn = document.createElement('button')
        editBtn.className = 'icon-btn-tiny'
        editBtn.textContent = '‚úèÔ∏è'
        editBtn.title = 'ÁºñËæë'
        editBtn.style.padding = '0'
        editBtn.style.width = '24px'
        editBtn.style.height = '24px'
        editBtn.style.borderRadius = '4px'
        editBtn.style.background = 'transparent'
        editBtn.style.color = '#6b7280'
        editBtn.style.border = '1px solid transparent'
        editBtn.style.cursor = 'pointer'
        editBtn.onmouseover = () => editBtn.style.background = '#e5e7eb'
        editBtn.onmouseout = () => editBtn.style.background = 'transparent'

        const moreBtn = document.createElement('button')
        moreBtn.className = 'icon-btn-tiny'
        moreBtn.textContent = '‚ãÆ'
        moreBtn.title = 'Êõ¥Â§ö'
        moreBtn.style.padding = '0'
        moreBtn.style.width = '24px'
        moreBtn.style.height = '24px'
        moreBtn.style.borderRadius = '4px'
        moreBtn.style.background = 'transparent'
        moreBtn.style.color = '#6b7280'
        moreBtn.style.border = '1px solid transparent'
        moreBtn.style.cursor = 'pointer'
        moreBtn.onmouseover = () => moreBtn.style.background = '#e5e7eb'
        moreBtn.onmouseout = () => moreBtn.style.background = 'transparent'

        actions.appendChild(editBtn)
        actions.appendChild(moreBtn)

        const startInlineEdit = () => {
          if (card.classList.contains('editing')) return
          card.classList.add('editing')

          const originalContent = n.content
          body.style.display = 'none'
          actions.style.display = 'none'

          const editor = document.createElement('div')
          editor.className = 'inline-editor'
          editor.style.marginTop = '8px'
          editor.style.display = 'flex'
          editor.style.flexDirection = 'column'
          editor.style.gap = '8px'

          const ta = document.createElement('textarea')
          ta.value = originalContent
          ta.rows = 1
          ta.style.width = '100%'
          ta.style.padding = '8px'
          ta.style.border = '1px solid #d1d5db'
          ta.style.borderRadius = '6px'
          ta.style.resize = 'none'
          ta.style.overflowY = 'hidden'
          ta.style.fontFamily = 'inherit'
          ta.style.fontSize = 'inherit'
          ta.style.lineHeight = '1.5'
          ta.style.minHeight = '38px'
          ta.style.flex = 'none' // Prevent global CSS flex:1 from resizing it

          const autoResize = () => {
            ta.style.height = 'auto'
            ta.style.height = ta.scrollHeight + 'px'
          }
          ta.addEventListener('input', autoResize)

          const btnRow = document.createElement('div')
          btnRow.style.display = 'flex'
          btnRow.style.justifyContent = 'flex-end'
          btnRow.style.gap = '8px'

          const btnCancel = document.createElement('button')
          btnCancel.textContent = 'ÂèñÊ∂à'
          btnCancel.style.padding = '4px 10px'
          btnCancel.style.fontSize = '12px'
          btnCancel.style.background = '#f3f4f6'
          btnCancel.style.color = '#374151'
          btnCancel.style.borderRadius = '4px'
          btnCancel.style.border = 'none'
          btnCancel.style.cursor = 'pointer'
          btnCancel.onclick = () => {
            editor.remove()
            body.style.display = 'block'
            actions.style.display = 'flex'
            card.classList.remove('editing')
          }

          const btnSave = document.createElement('button')
          btnSave.textContent = '‰øùÂ≠ò'
          btnSave.style.padding = '4px 10px'
          btnSave.style.fontSize = '12px'
          btnSave.style.background = '#3b82f6'
          btnSave.style.color = 'white'
          btnSave.style.borderRadius = '4px'
          btnSave.style.border = 'none'
          btnSave.style.cursor = 'pointer'
          btnSave.onclick = async () => {
            const v = ta.value.trim()
            if (v === originalContent) {
              btnCancel.click()
              return
            }
            try {
              await fetch('/api/notes/' + n.id, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: v }) })
              const notes = await fetch('/api/notes/' + encodeURIComponent(currentPhone)).then(r => r.json())
              renderNoteCards(notes)
            } catch (err) {
              alert('‰øùÂ≠òÂ§±Ë¥•')
            }
          }

          btnRow.appendChild(btnCancel)
          btnRow.appendChild(btnSave)
          editor.appendChild(ta)
          editor.appendChild(btnRow)
          card.appendChild(editor)

          requestAnimationFrame(() => {
            autoResize()
            ta.focus()
            ta.setSelectionRange(ta.value.length, ta.value.length)
          })
        }

        editBtn.onclick = (e) => {
          e.stopPropagation()
          startInlineEdit()
        }

        moreBtn.onclick = (e) => {
          e.stopPropagation()

          // Remove any existing active menus
          const existing = document.getElementById('activeNoteMenu')
          if (existing) existing.remove()
          menuOverlay.classList.remove('hidden')

          const menu = document.createElement('div')
          menu.id = 'activeNoteMenu'
          menu.className = 'card-menu popup-menu'
          menu.style.position = 'fixed'
          menu.style.zIndex = '10001'

          const pinItem = document.createElement('div')
          pinItem.className = 'popup-item'
          pinItem.textContent = n.pinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'ÁΩÆÈ°∂'
          pinItem.onclick = async () => {
            await fetch('/api/notes/' + n.id + '/pin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pinned: !n.pinned }) })
            const notes = await fetch('/api/notes/' + encodeURIComponent(currentPhone)).then(r => r.json())
            renderNoteCards(notes)
            closeMenu()
          }

          const delItem = document.createElement('div')
          delItem.className = 'popup-item danger'
          delItem.style.color = '#ff4d4f'
          delItem.textContent = 'Âà†Èô§'
          delItem.onclick = async () => {
            if (!confirm('Á°ÆËÆ§Âà†Èô§Ê≠§Êù°Â§áÊ≥®?')) return
            await fetch('/api/notes/' + n.id, { method: 'DELETE' })
            const notes = await fetch('/api/notes/' + encodeURIComponent(currentPhone)).then(r => r.json())
            renderNoteCards(notes)
            closeMenu()
          }

          menu.appendChild(pinItem)
          menu.appendChild(delItem)
          document.body.appendChild(menu)

          // Positioning
          const rect = moreBtn.getBoundingClientRect()
          menu.style.top = (rect.bottom + 4) + 'px'
          // Align right edge of menu with right edge of button
          // We don't know menu width yet, but we can set right.
          // Since it's fixed, right property works relative to viewport.
          // rect.right is distance from left edge to right edge.
          // Distance from right edge of viewport is window.innerWidth - rect.right.
          menu.style.right = (window.innerWidth - rect.right) + 'px'
          menu.style.left = 'auto'

          const closeMenu = () => {
            if (menu.parentNode) menu.remove()
            menuOverlay.classList.add('hidden')
          }

          menuOverlay.onclick = closeMenu
        }

        card.appendChild(head)
        card.appendChild(body)
        card.appendChild(actions)

        noteCards.appendChild(card)
      })
    }

    function updateBadge(count) {
      try { if (window.electronAPI) window.electronAPI.updateBadge(count) } catch { }
      try { if (navigator.setAppBadge) navigator.setAppBadge(count); } catch { }
      document.title = (count > 0 ? `(${count}) ` : '') + 'ÂÆ¢ÊúçÊéßÂà∂Âè∞'
    }

    function loadCachedConversations() {
      try {
        const raw = localStorage.getItem('im:conv') || '[]'
        const arr = JSON.parse(raw)
        if (Array.isArray(arr) && arr.length) { conversations = arr; renderList(conversations) }
      } catch { }
    }
    async function refreshConversations() {
      try {
        const r = await fetch('/api/conversations?t=' + Date.now())
        if (!r.ok) {
          if (r.status === 401) showTokenBar()
          renderList(conversations)
          return
        }
        const data = await r.json()
        conversations = Array.isArray(data) ? data : []
        try { localStorage.setItem('im:conv', JSON.stringify(conversations)) } catch { }
        renderList(conversations)
      } catch (_) {
        renderList(conversations)
      }
    }

    async function loadConversation(phone) {
      currentPhone = phone
      messagesEl.innerHTML = ''
      msgs = []
      socket.emit('join', { phone, role: 'agent' })
      const user = await fetch('/api/user/' + encodeURIComponent(phone)).then(r => r.ok ? r.json() : null)
      if (user) {
        phoneEl.textContent = user.phone || ''
        nameEl.textContent = user.name || ''
        avatarEl.onerror = () => { try { avatarEl.src = '/logo.png'; avatarEl.style.display = 'block' } catch { } }
        avatarEl.src = user.avatar || '/logo.png'
        avatarEl.style.display = 'block'
      } else {
        phoneEl.textContent = phone
        nameEl.textContent = ''
        avatarEl.onerror = () => { try { avatarEl.src = '/logo.png'; avatarEl.style.display = 'block' } catch { } }
        avatarEl.src = '/logo.png'
        avatarEl.style.display = 'block'
      }
      const note = await fetch('/api/note/' + encodeURIComponent(phone)).then(r => r.json())
      noteInput.value = ''
      const notes = await fetch('/api/notes/' + encodeURIComponent(phone)).then(r => r.json())
      renderNoteCards(notes)
      rbPhone.textContent = user && user.phone ? user.phone : phone
      rbName.textContent = user && user.name ? user.name : ''
      rbCountry.textContent = (user && user.country && !/undefined/i.test(String(user.country))) ? user.country : ''
      rightbar.classList.remove('hidden')
      composerEl.classList.remove('hidden')
      const history = await fetch('/api/messages/' + encodeURIComponent(phone)).then(r => r.json())
      history.forEach(renderMessage)
      autoScroll = true
      forceScrollBottom()
      setTimeout(forceScrollBottom, 500)
      setTimeout(forceScrollBottom, 1000)
      setTimeout(forceScrollBottom, 2500)

      const lastTs = history.length ? history[history.length - 1].ts : Date.now()
      await fetch('/api/read', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone, ts: lastTs }) })
      setPresence(!!(conversations.find(x => x.phone === phone) || {}).online)
      const lastAgent = [...history].reverse().find(m => m.sender === 'agent')
      lastAgentTs = lastAgent ? lastAgent.ts : 0
      const conv = conversations.find(x => x.phone === phone)
      const seenTs = conv && conv.last_seen_ts ? conv.last_seen_ts : 0
      setReadStatus(lastAgent ? lastAgent.ts <= seenTs : false)
      const idx = conversations.findIndex(x => x.phone === phone)
      if (idx >= 0) {
        conversations[idx].unread_count = 0
        renderList(conversations)
      }
    }

    searchBtn.onclick = () => {
      const phone = searchPhone.value.trim()
      if (!phone) return
      loadConversation(phone)
      loadConversation(phone)
    }

    let activeCtxMenu = null
    function showContextMenu(e, item) {
      if (activeCtxMenu) activeCtxMenu.remove()
      const menu = document.createElement('div')
      menu.className = 'ctx-menu'
      const mk = (text, cls, fn) => {
        const el = document.createElement('div')
        el.className = 'ctx-menu-item' + (cls ? ' ' + cls : '')
        el.textContent = text
        el.onclick = () => { fn(); menu.remove(); activeCtxMenu = null; menuOverlay.classList.add('hidden') }
        return el
      }
      menu.appendChild(mk(item.pinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'ÁΩÆÈ°∂ÂØπËØù', '', () => togglePin(item)))
      menu.appendChild(mk('Âà†Èô§ÂØπËØù', 'danger', () => deleteConv(item)))

      menu.style.top = e.clientY + 'px'
      menu.style.left = e.clientX + 'px'
      document.body.appendChild(menu)
      activeCtxMenu = menu
      menuOverlay.classList.remove('hidden')
      menuOverlay.onclick = () => {
        if (activeCtxMenu) activeCtxMenu.remove()
        menuOverlay.classList.add('hidden')
      }
    }

    async function togglePin(item) {
      alert('Debug: Start Pinning Phone=' + item.phone)
      try {
        const r = await fetch('/api/conversation/' + item.phone + '/pin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pinned: !item.pinned })
        })
        if (!r.ok) throw new Error(r.status + ' ' + (await r.text()))
        refreshConversations()
      } catch (e) {
        alert('Êìç‰ΩúÂ§±Ë¥•: ' + e.message)
      }
    }

    async function deleteConv(item) {
      alert('Debug: Start Deleting Phone=' + item.phone)
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§‰∏é ' + (item.name || item.phone) + ' ÁöÑÂØπËØùÂêóÔºü\nÊ≥®ÊÑèÔºöËøôÂ∞ÜÊ∞∏‰πÖÂà†Èô§ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºÅ')) return
      try {
        const r = await fetch('/api/conversation/' + item.phone, { method: 'DELETE' })
        if (!r.ok) throw new Error(r.status + ' ' + (await r.text()))
        if (currentPhone === item.phone) {
          currentPhone = null
          messagesEl.innerHTML = ''
          rightbar.classList.add('hidden')
          composerEl.classList.add('hidden')
        }
        refreshConversations()
      } catch (e) {
        alert('Âà†Èô§Â§±Ë¥•: ' + e.message)
      }
    }

    const testAudioBtn = document.getElementById('testAudioBtn')
    if (testAudioBtn) {
      testAudioBtn.onclick = () => {
        const a = document.getElementById('notifyAudio')
        if (a) { a.currentTime = 0; a.play().catch(e => console.error(e)) }
        if (window.electronAPI) window.electronAPI.showNotification('ÊµãËØïÈÄöÁü•', 'ËøôÊòØ‰∏ÄÊù°ÊµãËØïÁî®ÁöÑÁ≥ªÁªüÈÄöÁü•')
        else if (typeof Notification !== 'undefined' && Notification.permission !== 'granted') Notification.requestPermission()
      }
    }

    function doSend() {
      if (!currentPhone) {
        const p = (phoneEl.textContent || '').trim() || (searchPhone.value || '').trim()
        if (!p) return
        currentPhone = p
        socket.emit('join', { phone: currentPhone, role: 'agent' })
      }
      const content = messageInput.value.trim()
      if (!content) return
      socket.emit('message', { phone: currentPhone, sender: 'agent', content, reply_to: replyToId })
      const mlocal = { id: 'local-' + Date.now(), phone: currentPhone, sender: 'agent', content, ts: Date.now(), type: null, reply_to: replyToId || null }
      const div = document.createElement('div')
      div.className = 'msg me'
      div.dataset.id = mlocal.id
      div.dataset.local = '1'
      const txt = document.createElement('div')
      txt.textContent = content
      div.appendChild(txt)
      messagesEl.appendChild(div)
      msgs.push(mlocal)
      const i = conversations.findIndex(x => x.phone === currentPhone)
      if (i >= 0) { const now = mlocal.ts; conversations[i].last_agent_ts = now; conversations[i].last_content = content; conversations[i].last_ts = now; renderList(conversations) }
      lastAgentTs = mlocal.ts
      setReadStatus(false)
      messageInput.value = ''
      updateComposerHeight()
      replyToId = null
      replyPreview.classList.add('hidden')
      forceScrollBottom()
      setTimeout(forceScrollBottom, 100)
    }
    sendBtn.onclick = doSend

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.matchMedia('(pointer: coarse)').matches
    messageInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !isMobile && !e.shiftKey && !e.isComposing) {
        e.preventDefault()
        doSend()
      }
    })

    function updateComposerHeight() {
      const maxH = Math.floor(messagesEl.clientHeight / 3)
      messageInput.style.height = 'auto'
      const h = Math.min(messageInput.scrollHeight, maxH)
      messageInput.style.height = h + 'px'
      messageInput.style.overflowY = messageInput.scrollHeight > maxH ? 'auto' : 'hidden'
    }
    messageInput.addEventListener('input', updateComposerHeight)
    window.addEventListener('resize', updateComposerHeight)
    messageInput.addEventListener('paste', e => {
      const cd = e.clipboardData
      if (!cd) return
      const item = Array.from(cd.items || []).find(x => x.type && x.type.indexOf('image/') === 0)
      const file = item && item.getAsFile ? item.getAsFile() : (cd.files && cd.files[0])
      if (!file) return
      if (file.size > 5 * 1024 * 1024 || !/^image\//.test(file.type)) return
      const url = URL.createObjectURL(file)
      previewOverlay._img.src = url
      previewOverlay.classList.remove('hidden')
      const close = () => { previewOverlay.classList.add('hidden'); URL.revokeObjectURL(url) }
      previewOverlay._cancel.onclick = close
      previewOverlay._send.onclick = async () => {
        if (!currentPhone) return close()
        const fd = new FormData()
        fd.append('file', file)
        const r = await fetch('/api/upload', { method: 'POST', body: fd }).then(r => r.json())
        if (r && r.url) {
          const u = (apiBase || '') + r.url
          socket.emit('message', { phone: currentPhone, sender: 'agent', content: u, type: 'image', reply_to: replyToId })
        }
        close()
      }
    })

    emojiBtn.onclick = () => {
      emojiMenu.classList.toggle('hidden')
    }
    emojiMenu.querySelectorAll('.emoji-item').forEach(el => {
      el.onclick = () => {
        messageInput.value += el.textContent
        emojiMenu.classList.add('hidden')
        messageInput.focus()
      }
    })
    plusBtn.onclick = () => {
      plusMenu.classList.toggle('hidden')
    }
    plusMenu.onclick = () => {
      photoInput.click()
    }
    async function ensureCsrf() {
      try {
        const r = await fetch('/api/csrf', { method: 'GET' })
        const j = await r.json()
        return j && j.csrf ? j.csrf : ''
      } catch (_) { return '' }
    }
    photoInput.onchange = async () => {
      const f = photoInput.files[0]
      if (!f || !currentPhone) return
      if (f.size > 5 * 1024 * 1024) { photoInput.value = ''; return }
      const fd = new FormData()
      fd.append('file', f)
      const csrf = await ensureCsrf()
      const r = await fetch('/api/upload', { method: 'POST', headers: csrf ? { 'x-csrf-token': csrf } : {}, body: fd }).then(r => r.json()).catch(() => null)
      if (r && r.url) {
        const u = (apiBase || '') + r.url
        socket.emit('message', { phone: currentPhone, sender: 'agent', content: u, type: 'image', reply_to: replyToId })
        const mlocal = { id: 'local-' + Date.now(), phone: currentPhone, sender: 'agent', content: u, ts: Date.now(), type: 'image', reply_to: replyToId || null }
        const div = document.createElement('div')
        div.className = 'msg me'
        div.dataset.id = mlocal.id
        div.dataset.local = '1'
        const img = document.createElement('img')
        img.src = u
        img.className = 'msg-image'
        div.appendChild(img)
        messagesEl.appendChild(div)
        msgs.push(mlocal)
        const i = conversations.findIndex(x => x.phone === currentPhone)
        if (i >= 0) { const now = mlocal.ts; conversations[i].last_agent_ts = now; conversations[i].last_content = 'ÂõæÁâá'; conversations[i].last_ts = now; renderList(conversations) }
        lastAgentTs = mlocal.ts
        setReadStatus(false)
      }
      photoInput.value = ''
      plusMenu.classList.add('hidden')
      replyToId = null
      replyPreview.classList.add('hidden')
    }

    socket.on('message', m => {
      // Âè™Â§ÑÁêÜÂΩìÂâçËÅäÂ§©Á™óÂè£ÁöÑÊ∂àÊÅØÊ∏≤ÊüìÔºåÂàóË°®Êõ¥Êñ∞Áî± message_feed Â§ÑÁêÜ
      if (!currentPhone || m.phone !== currentPhone) {
        // ‰∏çÊòØÂΩìÂâçËÅäÂ§©Ôºå‰∏çÊ∏≤ÊüìÊ∂àÊÅØÔºåÂàóË°®Êõ¥Êñ∞Â∑≤Áî± message_feed Â§ÑÁêÜ
        return
      }
      
      if (m.sender === 'agent') {
        const lastLocal = messagesEl.querySelector('.msg.me[data-local="1"]')
        if (lastLocal) {
          const li = lastLocal.querySelector('.msg-image')
          if ((m.type === 'image' && li && li.src === m.content) || (m.type !== 'image' && lastLocal.textContent === m.content)) { try { lastLocal.remove() } catch { } }
        }
      }
      renderMessage(m)
      
      if (m.sender === 'agent') {
        lastAgentTs = m.ts || lastAgentTs
        setReadStatus(false)
        const i = conversations.findIndex(x => x.phone === currentPhone)
        if (i >= 0) { conversations[i].last_agent_ts = m.ts; conversations[i].last_content = m.type === 'image' ? 'ÂõæÁâá' : m.content; conversations[i].last_ts = m.ts; renderList(conversations) }
        forceScrollBottom()
      } else {
        // ÂÆ¢Êà∑Ê∂àÊÅØÔºåÊ†áËÆ∞Â∑≤ËØª
        fetch('/api/read', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone: currentPhone, ts: m.ts }) })
        const i = conversations.findIndex(x => x.phone === currentPhone)
        if (i >= 0) { conversations[i].unread_count = 0; conversations[i].last_content = m.type === 'image' ? 'ÂõæÁâá' : m.content; conversations[i].last_ts = m.ts; renderList(conversations) }
        if (autoScroll) forceScrollBottom()
        const last = messagesEl.lastElementChild
        if (last && autoScroll) last.scrollIntoView({ block: 'end' })
      }
    })
    // ÂèÆÂíöÊèêÁ§∫Èü≥ - ‰ΩøÁî® HTML5 Audio (Êõ¥ÂèØÈù†)
    // Base64 ÁºñÁ†ÅÁöÑÂèÆÂíöÂ£∞Èü≥
    const DING_DONG_SOUND = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbsYE8teleqd7LkVs0NW2NxN/JlVY0NW2NxN/JlVY0NGmHud7VoWI5NWB7q9zfoWo+NV91n9XinXRINWJrlsrgonpQNWRlicLkp4FYNV9bhLjlqolkN1dOdqzlro9uPlBEdKPksJV3R0s5b5rjsZl9UUcubJHgsJ6EWUQmZ4ndraOLYkEeY4DXqaiRakAXXnbOpq2YdD0QWWvFoLGfgDoKU2C8mr6pjTYGTV2zmMCylTABRlWqk8S8nysARVColMa/oib/QU6hkcjBpyT9PkmZjcrEqyP8O0OPh8zHsCL6NjyDfM3LtSL5MTZ2cs3OuiL4LTBqaM7RwCP3KSlcXc/UxyT2JSJQUs/YzCX2IRtERM/cziX2HhM2N8/gzyb1GgsqK87j0yj0FgQeH87n1ir0EgASD83r2iz0DgAIB8vv3i/zCwAAAMnz4TLyBwAAAMf25TXxBAABAMX56DjwAgAEAMP87zzvAAAHAMIA8kDtAAELAL8A9kTrAAIPALwA+kjpAAQTALkA/UzmAAgXALYBAU/kAAwcALMBA1LhABEgAK8CBlXeABckAKwCCFjcAB0oAKkDC1vZACMrAKYDDl7WACorAKMEEWHTADIuAKAEFGTRADkxAJ0FGGfOAEE1AJoGG2rLAEo4AJcGH23IAFRAelEWAL3//m7FAIc3AJQIJXHCAFs0B5QGKHS/AEI4AJgHM3e8AD4+ZE8MAL/+/ne5AFsvAJgJOnq2AEE3AJkJPn2zAEFDe0YKAMP9/3+wAEBBAJoLR4KtAEA/AJsLS4WqAEA9AJwMT4inAEE7AJ0NVIukAEI6AJ8OWI6hAEM5AKAPXZGeAEU4AKIQYpSbAEc4AKMRZpeYAEo3AKUSa5qVAEw3AKcTb52SAE83AKkUdKCPAFI3AKsVeaOMAFU3AK0Wfaab'
    let _notifyAudio = null
    
    function playDingDong() {
      console.log('[Sound] Attempting to play ding dong...')
      // Áõ¥Êé•‰ΩøÁî® Web Audio API ÁîüÊàêÂèÆÂíöÂ£∞Èü≥
      _playWebAudioDingDong()
    }
    
    // Â§áÁî®ÊñπÂºè: Web Audio API
    let _notifyCtx = null
    function _playWebAudioDingDong() {
      try {
        if (!_notifyCtx) _notifyCtx = new (window.AudioContext || window.webkitAudioContext)()
        if (_notifyCtx.state === 'suspended') {
          _notifyCtx.resume().then(() => _genDingDong())
        } else {
          _genDingDong()
        }
      } catch (e) { console.error('Web Audio error:', e) }
    }
    
    function _genDingDong() {
      try {
        const now = _notifyCtx.currentTime
        // ÂèÆ - È´òÈü≥ (E6 ~1319Hz)
        const osc1 = _notifyCtx.createOscillator()
        const gain1 = _notifyCtx.createGain()
        osc1.connect(gain1)
        gain1.connect(_notifyCtx.destination)
        osc1.frequency.value = 1319
        osc1.type = 'sine'
        gain1.gain.setValueAtTime(0.6, now)
        gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.3)
        osc1.start(now)
        osc1.stop(now + 0.3)
        // Âíö - ‰ΩéÈü≥ (G5 ~784Hz)
        const osc2 = _notifyCtx.createOscillator()
        const gain2 = _notifyCtx.createGain()
        osc2.connect(gain2)
        gain2.connect(_notifyCtx.destination)
        osc2.frequency.value = 784
        osc2.type = 'sine'
        gain2.gain.setValueAtTime(0.5, now + 0.15)
        gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.5)
        osc2.start(now + 0.15)
        osc2.stop(now + 0.5)
        console.log('[Sound] Web Audio ding dong played')
      } catch (e) { console.error('Web Audio play error:', e) }
    }
    
    // Ëß£ÈîÅÈü≥È¢ë - Â§öÁßçÊñπÂºè
    function unlockAudio() {
      try {
        // È¢ÑÂä†ËΩΩ HTML5 Audio
        if (!_notifyAudio) {
          _notifyAudio = new Audio(DING_DONG_SOUND)
          _notifyAudio.volume = 1.0
        }
        // ÂàùÂßãÂåñ Web Audio Context
        if (!_notifyCtx) _notifyCtx = new (window.AudioContext || window.webkitAudioContext)()
        if (_notifyCtx.state === 'suspended') _notifyCtx.resume()
        console.log('[Audio] Unlocked, context state:', _notifyCtx?.state)
      } catch (e) { console.error('[Audio] Unlock error:', e) }
    }
    document.addEventListener('click', unlockAudio)
    document.addEventListener('keydown', unlockAudio)
    document.addEventListener('touchstart', unlockAudio)
    setTimeout(unlockAudio, 100)
    
    function notifyNewMessage(m) {
      try {
        if (!m || m.sender !== 'customer') return
        // Êí≠ÊîæÂèÆÂíöÂ£∞
        playDingDong()

        const tx = m.type === 'image' ? '[ÂõæÁâá]' : (m.content || '')
        if (window.electronAPI) {
          window.electronAPI.showNotification('Êñ∞Ê∂àÊÅØ: ' + (m.phone || 'Êú™Áü•'), tx)
        } else if (typeof Notification !== 'undefined') {
          if (Notification.permission === 'granted') {
            const n = new Notification('Êñ∞Ê∂àÊÅØ: ' + (m.phone || 'Êú™Áü•'), { body: tx, icon: '/im-api/tiny.png', silent: false, requireInteraction: true })
            n.onclick = () => { window.focus(); loadConversation(m.phone) }
          } else if (Notification.permission !== 'denied') {
            Notification.requestPermission()
          }
        }
      } catch (e) { console.error(e) }
    }

    if (typeof Notification !== 'undefined' && Notification.permission !== 'granted') {
      try { Notification.requestPermission() } catch { }
    }

    socket.on('message_feed', m => {
      console.log('[message_feed] Received:', m.phone, m.sender, m.content?.substring(0, 20))
      if (!Array.isArray(conversations)) conversations = []
      const i = conversations.findIndex(x => x.phone === m.phone)
      if (i >= 0) {
        // Êõ¥Êñ∞Áé∞ÊúâÂØπËØù
        if (m.sender === 'agent') conversations[i].last_agent_ts = m.ts
        // Â¶ÇÊûú‰∏çÊòØÂΩìÂâçÊâìÂºÄÁöÑËÅäÂ§©Á™óÂè£ÔºåÂ¢ûÂä†Êú™ËØªËÆ°Êï∞
        if (m.sender === 'customer' && m.phone !== currentPhone) {
          conversations[i].unread_count = (conversations[i].unread_count || 0) + 1
        }
        conversations[i].last_content = m.type === 'image' ? 'ÂõæÁâá' : m.content
        conversations[i].last_ts = m.ts
        renderList(conversations)
      } else {
        // Êñ∞Áî®Êà∑ÔºåÊ∑ªÂä†Âà∞ÂàóË°®
        const newConv = {
          phone: m.phone,
          name: '',
          avatar: '',
          note: '',
          last_content: m.type === 'image' ? 'ÂõæÁâá' : m.content,
          last_ts: m.ts,
          last_agent_ts: m.sender === 'agent' ? m.ts : null,
          unread_count: m.sender === 'customer' ? 1 : 0,
          online: true
        }
        conversations.unshift(newConv)
        renderList(conversations)
      }
      // ÂÆ¢Êà∑Ê∂àÊÅØÊí≠ÊîæÊèêÁ§∫Èü≥
      if (m.sender === 'customer') {
        console.log('[message_feed] Playing notification for customer message')
        notifyNewMessage(m)
      }
    })
    socket.on('recalled', r => {
      if (!currentPhone || r.phone !== currentPhone) return
      const el = messagesEl.querySelector('[data-id="' + r.id + '"]')
      if (!el) return
      if (r.by === 'customer') {
        el.innerHTML = ''
        el.className = 'msg other'
        const prev = msgs.find(x => x.id === r.id)
        const label = prev && prev.type === 'image' ? 'ÂõæÁâá' : (r.content || '')
        el.textContent = 'Áî®Êà∑Â∑≤Êí§ÂõûÊ∂àÊÅØÔºö' + label
        msgs = msgs.map(x => x.id === r.id ? { ...x, type: 'recall' } : x)
        const i = conversations.findIndex(x => x.phone === r.phone)
        if (i >= 0) { conversations[i].last_content = 'Áî®Êà∑Â∑≤Êí§ÂõûÊ∂àÊÅØ'; conversations[i].last_ts = Date.now(); renderList(conversations) }
      } else {
        el.remove()
        msgs = msgs.filter(x => x.id !== r.id)
        const i = conversations.findIndex(x => x.phone === r.phone)
        if (i >= 0) { renderList(conversations) }
      }
      forceScrollBottom()
    })

    socket.on('presence', p => {
      const i = conversations.findIndex(x => x.phone === p.phone)
      if (i >= 0) conversations[i].online = p.online
      if (currentPhone === p.phone) setPresence(p.online)
      renderList(conversations)
    })

    socket.on('read-status', r => {
      const i = conversations.findIndex(x => x.phone === r.phone)
      if (i >= 0) conversations[i].last_seen_ts = r.last_seen_ts
      renderList(conversations)
      if (currentPhone === r.phone) {
        setReadStatus(r.last_seen_ts >= lastAgentTs)
      }
    })

    saveNoteBtn.onclick = async () => {
      if (!currentPhone) return
      const note = noteInput.value.trim()
      if (!note) return
      await fetch('/api/note', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone: currentPhone, note }) })
      const notes = await fetch('/api/notes/' + encodeURIComponent(currentPhone)).then(r => r.json())
      renderNoteCards(notes)
    }

    // ÂõæÁâáÊîæÂ§ßÊü•Áúã
    const lightbox = document.createElement('div')
    lightbox.id = 'lightbox'
    lightbox.className = 'lightbox hidden'
    const lightImg = document.createElement('img')
    lightImg.id = 'lightboxImage'
    lightbox.appendChild(lightImg)
    document.body.appendChild(lightbox)
    messagesEl.addEventListener('click', e => {
      const t = e.target
      if (t && t.classList.contains('msg-image')) {
        lightImg.src = t.src
        lightbox.classList.remove('hidden')
      }
    })
    lightbox.onclick = () => {
      lightbox.classList.add('hidden')
    }

    loadCachedConversations()
    refreshConversations()
    const autoPhone = qs.get('phone') || ''
    if (autoPhone) {
      try { loadConversation(autoPhone) } catch { }
    }

    // Old Duplicate Function Removed
  </script>
</body>

</html>